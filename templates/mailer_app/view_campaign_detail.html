{% extends "mailer_app/base.html" %}

{% block title %}{{ title }} - Bulk Emailer{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center">
                <div>
                    <h2 class="h4 mb-1 text-primary">{{ campaign.name }}</h2>
                    <p class="text-sm text-muted mb-0">Status: 
                        <span class="fw-semibold
                            {% if campaign.status == 'draft' %} text-warning
                            {% elif campaign.status == 'scheduled' %} text-info
                            {% elif campaign.status == 'queued' %} text-secondary
                            {% elif campaign.status == 'sending' %} text-primary
                            {% elif campaign.status == 'sent' %} text-success
                            {% elif campaign.status == 'failed' %} text-danger
                            {% else %} text-muted {% endif %}">
                            {{ campaign.get_status_display }}
                        </span>
                    </p>
                </div>
                <div class="mt-2 mt-sm-0">
                    <a href="{% url 'mailer_app:manage_campaigns' %}" class="btn btn-sm btn-outline-secondary">Back to Campaigns</a>
                    </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row text-sm">
                <div class="col-md-6">
                    <p><strong>Target Contact List(s):</strong>
                        {% if campaign.contact_lists.exists %}
                            <ul class="list-unstyled ms-3">
                            {% for clist in campaign.contact_lists.all %}
                                <li>{{ clist.name }} ({{ clist.contacts.count }} contacts)</li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <span class="text-muted">Not set</span>
                        {% endif %}
                    </p>
                    <p><strong>Email Template:</strong> {{ campaign.email_template.name|default:"Not set" }}</p>
                    {% if campaign.scheduled_at %}
                    <p><strong>Scheduled At:</strong> {{ campaign.scheduled_at|date:"Y-m-d H:i" }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <p><strong>Total Recipients (Est.):</strong> {{ campaign.total_recipients }}</p>
                    <p><strong>Successfully Sent:</strong> {{ campaign.successfully_sent }}</p>
                    <p><strong>Failed to Send:</strong> {{ campaign.failed_to_send }}</p>
                    <p><strong>Last Sent At:</strong> {{ campaign.sent_at|date:"Y-m-d H:i"|default:"Not sent yet" }}</p>
                </div>
            </div>
            
            {% if campaign.email_template and available_merge_tags %}
            <div class="mt-3 pt-3 border-top">
                <p class="text-xs text-muted"><strong>Available merge tags for template '{{campaign.email_template.name}}':</strong></p>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    {% for tag in available_merge_tags %}
                        <code class="text-xs bg-light text-dark px-1 py-0.5 rounded border">{{ tag }}</code>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if campaign.status == 'draft' or campaign.status == 'failed' or campaign.status == 'scheduled' %}
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h3 class="h6 mb-0 text-primary">1. Send Test Email</h3>
                </div>
                <div class="card-body">
                    {% if campaign.email_template %}
                        <form action="{% url 'mailer_app:send_test_email_campaign' campaign.id %}" method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="{{ test_email_form.test_email_address.id_for_label }}" class="form-label">{{ test_email_form.test_email_address.label }}</label>
                                {{ test_email_form.test_email_address }}
                                {% for error in test_email_form.test_email_address.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ test_email_form.email_template.id_for_label }}" class="form-label">{{ test_email_form.email_template.label }}</label>
                                {{ test_email_form.email_template }}
                                <small class="form-text text-muted d-block">Currently: {{campaign.email_template.name}}</small>
                                {% for error in test_email_form.email_template.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                            </div>
                            <button type="submit" class="btn btn-success w-100">Send Test</button>
                        </form>
                        <p class="text-xs text-muted mt-2">
                            Sends a preview of the '{{ campaign.email_template.name }}' template to your specified email address using sample data.
                        </p>
                        <a href="{% url 'mailer_app:preview_email_template_page' campaign.email_template.id %}" class="link-primary text-sm mt-2 d-inline-block" target="_blank">
                            Open Template Preview &rarr;
                        </a>
                    {% else %}
                        <p class="text-muted">Please select an email template for this campaign to send a test.</p>
                        {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                 <div class="card-header">
                    <h3 class="h6 mb-0 text-danger">2. Send Campaign to List(s)</h3>
                </div>
                <div class="card-body">
                    {% if campaign.contact_lists.exists and campaign.email_template %}
                        <p class="text-sm text-dark mb-2">
                            This will queue the email template '<strong>{{ campaign.email_template.name }}</strong>'
                            to be sent to all <strong>{{ campaign.total_recipients }}</strong> subscribed contacts in the selected list(s).
                        </p>
                        <form action="{% url 'mailer_app:execute_send_campaign' campaign.id %}" method="post" onsubmit="return confirm('Are you absolutely sure you want to queue this campaign for sending to {{ campaign.total_recipients }} contacts? This action will start the process.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger w-100">
                                QUEUE CAMPAIGN FOR SENDING
                            </button>
                        </form>
                        <p class="text-xs text-danger mt-2 fw-semibold">Warning: This will queue the campaign. Ensure template and lists are correct.</p>
                    {% else %}
                        <p class="text-muted">Please ensure at least one contact list and an email template are selected for this campaign before sending.</p>
                         {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% elif campaign.status == 'queued' or campaign.status == 'sending' %}
    <div class="card bg-info-light border border-info mb-4">
        <div class="card-body">
            <h3 class="h6 text-info-dark">Campaign Queued/Sending...</h3>
            <p class="text-sm text-info-dark">This campaign is currently being processed. Please check back later for status updates or view logs.</p>
            <div class="progress mt-2" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
        </div>
    </div>
    {% elif campaign.status == 'sent' %}
    <div class="card bg-success-light border border-success mb-4">
         <div class="card-body">
            <h3 class="h6 text-success-dark">Campaign Sent!</h3>
            <p class="text-sm text-success-dark">
                This campaign was marked as sent on {{ campaign.sent_at|date:"F j, Y, P" }}.
                <br>Successfully sent: {{ campaign.successfully_sent }}. Failed: {{ campaign.failed_to_send }}.
            </p>
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm mt-4">
        <div class="card-header bg-light">
            <h3 class="h6 mb-0 text-primary">Campaign Send Logs ({{ campaign.logs.count }})</h3>
        </div>
        <div class="card-body p-0">
            {% if campaign.logs.exists %}
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-striped table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="px-3 py-2 text-xs">Email Address</th>
                            <th class="px-3 py-2 text-xs">Status</th>
                            <th class="px-3 py-2 text-xs">Sent At</th>
                            <th class="px-3 py-2 text-xs">SES Message ID / Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in campaign.logs.all|dictsortreversed:"sent_at" %}
                        <tr>
                            <td class="px-3 py-2 text-sm text-break">{{ log.email_address }}</td>
                            <td class="px-3 py-2 text-sm">
                                {% if log.status == 'success' %}
                                    <span class="badge bg-success-light text-success-dark">Success</span>
                                {% else %}
                                    <span class="badge bg-danger-light text-danger-dark">Failed</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-2 text-sm">{{ log.sent_at|date:"Y-m-d H:i:s" }}</td>
                            <td class="px-3 py-2 text-xs text-muted" style="word-break: break-all;">
                                {% if log.status == 'success' and log.message_id %}
                                    {{ log.message_id }}
                                {% elif log.error_message %}
                                    {{ log.error_message|truncatechars:100 }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted p-3">No send logs available for this campaign yet.</p>
            {% endif %}
        </div>
    </div>
</div>
<style>
    .invalid-feedback.d-block { display: block; width: 100%; margin-top: .25rem; font-size: .875em; color: #dc3545;}
    .form-check { margin-bottom: 0.5rem; display: block; }
    .form-check-input { margin-right: 0.5em; }
    .bg-info-light { background-color: #cff4fc !important; } .text-info-dark { color: #055160 !important; }
    .bg-success-light { background-color: #d1e7dd !important; } .text-success-dark { color: #0f5132 !important; }
    .bg-danger-light { background-color: #f8d7da !important; } .text-danger-dark { color: #842029 !important; }
    .text-break { word-break: break-all; }
</style>
{% endblock %}
